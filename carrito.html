<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Carrito</title>
    <link rel="stylesheet" href="styles/carrito.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

</head>

<body>
    <div id ="navbar-container"></div>
    <div class="container py-5">
        <div class="card">
            <div class="row">
                <div class="col-md-8 cart">
                    <div class="title">
                        <div class="row">
                            <div class="col"><h4><b>Carrito</b></h4></div>
                                <div class="col align-self-center text-right text-muted" id="cart-items-count">0 items</div>
                        </div>
                    </div>
                    <div id="cart-products"></div>
                    <div class="back-to-shop"><a href="index.html">&leftarrow;</a><span class="text-muted">Volver a la tienda</span></div>
                </div>
                <div class="col-md-4 summary">
                    <div><h5><b>Resumen</b></h5></div>
                    <hr>
                    <div class="row">
                        <div class="col" style="padding-left:0;">ITEMS <span id="summary-items">0</span></div>
                        <div class="col text-right" id="summary-total">$0</div>
                    </div>
                    <form>
                        <p>ENVÍO</p>
                        <select><option class="text-muted">Despacho estándar - $5.000</option></select>
                        <p>CUPÓN</p>
                        <input id="code" placeholder="Ingresa tu cupón">
                    </form>
                    <div class="row" style="border-top: 1px solid rgba(0,0,0,.1); padding: 2vh 0;">
                        <div class="col">TOTAL</div>
                        <div class="col text-right" id="summary-grand">$0</div>
                    </div>
                    <button class="btn btn-success w-100">PAGAR</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/layout.js"></script>
    <script>
        window.layout.LoadPartials();
        const fmt = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });
        function renderCart() {
            const cart = JSON.parse(localStorage.getItem('APP_CART') || '[]');
            const prods = JSON.parse(localStorage.getItem('APP_PRODS') || '[]');
            const $products = $('#cart-products').empty();
            let total = 0;
            let items = 0;
            if (!cart.length) {
                $products.append('<div class="row border-top border-bottom"><div class="col text-center py-4">No hay productos en el carrito.</div></div>');
                $('#cart-items-count').text('0 items');
                $('#summary-items').text('0');
                $('#summary-total').text(fmt.format(0));
                $('#summary-grand').text(fmt.format(0));
                return;
            }
            cart.forEach(item => {
                const prod = prods.find(p => p.id == item.id) || {};
                const precio = Number(item.price) || 0;
                const qty = item.qty || 1;
                const subtotal = precio * qty;
                total += subtotal;
                items += qty;
                // Usar la imagen del producto destacado si existe
                let imgSrc = prod.img;
                if (!imgSrc) {
                  // fallback: buscar en tarjetas animadas del index
                  if (item.id == 1001) imgSrc = 'images/monstera.jpg';
                  else if (item.id == 1002) imgSrc = 'images/alocasia.jpg';
                  else if (item.id == 1003) imgSrc = 'images/ficus.jpg';
                  else imgSrc = `https://picsum.photos/seed/prod${prod.id || item.id}/600/400`;
                }
                $products.append(`
                <div class="row border-top border-bottom">
                    <div class="row main align-items-center py-3">
                        <div class="col-2"><img class="img-fluid" src="${imgSrc}" style="max-width:70px;"></div>
                        <div class="col">
                            <div class="row text-muted">${prod.nombre || item.name || 'Producto'}</div>
                            <div class="row">${prod.descripcion || ''}</div>
                        </div>
                        <div class="col d-flex align-items-center gap-2">
                            <a href="#" class="btn-qty" data-id="${item.id}" data-action="dec">-</a>
                            <span class="border px-2">${qty}</span>
                            <a href="#" class="btn-qty" data-id="${item.id}" data-action="inc">+</a>
                        </div>
                        <div class="col">${fmt.format(precio)} <span class="close btn-remove" data-id="${item.id}" style="cursor:pointer;">&#10005;</span></div>
                    </div>
                </div>
                `);
            });
            $('#cart-items-count').text(items + (items === 1 ? ' item' : ' items'));
            $('#summary-items').text(items);
            $('#summary-total').text(fmt.format(total));
            // Envío fijo de $5.000
            const envio = 5000;
            $('#summary-grand').text(fmt.format(total + envio));
        }
        $(function () {
            renderCart();
            // Eliminar producto
            $(document).on('click', '.btn-remove', function () {
                const id = Number($(this).data('id'));
                let cart = JSON.parse(localStorage.getItem('APP_CART') || '[]');
                cart = cart.filter(i => i.id !== id);
                localStorage.setItem('APP_CART', JSON.stringify(cart));
                renderCart();
            });
            // Cambiar cantidad
            $(document).on('click', '.btn-qty', function (e) {
                e.preventDefault();
                const id = Number($(this).data('id'));
                const action = $(this).data('action');
                let cart = JSON.parse(localStorage.getItem('APP_CART') || '[]');
                const idx = cart.findIndex(i => i.id === id);
                if (idx !== -1) {
                    if (action === 'inc') cart[idx].qty = (cart[idx].qty || 1) + 1;
                    if (action === 'dec' && cart[idx].qty > 1) cart[idx].qty--;
                }
                localStorage.setItem('APP_CART', JSON.stringify(cart));
                renderCart();
            });
        });
    </script>
</body>

</html>