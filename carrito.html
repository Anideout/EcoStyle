<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carro de compras
    </title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/navbar.css">
    <link rel="stylesheet" href="styles/carrito.css">
</head>
<body>
        <div id="navbar-container"></div>
        <div class="back-to-shop"><a href="index.html">&leftarrow;</a><span class="text-muted">Volver a la tienda</span></div>
        <div class="container-fluid">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-shopping-cart"></i> Carrito de compras</span>
                            <button class="btn btn-outline-danger btn-sm" id="btnVaciar">Vaciar carrito</button>
                        </div>
                        <div class="card-body">
                            <div id="cartEmpty" class="alert alert-info d-none">Tu carrito está vacío.</div>
                            <div class="table-responsive">
                                <table class="table align-middle" id="tablaCarrito">
                                    <thead>
                                        <tr>
                                            <th>#</th><th>Producto</th><th class="text-end">Precio</th><th class="text-center">Cantidad</th><th class="text-end">Subtotal</th><th></th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                    <tfoot>
                                        <tr>
                                            <th colspan="4" class="text-end">Total</th>
                                            <th class="text-end" id="cartTotal">$0</th>
                                            <th></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <div class="d-flex justify-content-end gap-2 mt-3">
                                <a class="btn btn-outline-secondary" href="catalogo.html">Seguir comprando</a>
                                <button class="btn btn-main" id="btnConfirmar" disabled>Confirmar compra</button>
                            </div>
                        </div>
                    </div>
                </div>
        <div id="footer-container"></div>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="assets/js/auth.js"></script>
        <script src="assets/js/Layout.js"></script>
        <script>
            const CART_KEY = 'APP_CART';
            const PROD_KEY = 'APP_PRODS';
            const fmt = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });

            function getCart() {
                try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch { return []; }
            }
            function saveCart(cart) {
                localStorage.setItem(CART_KEY, JSON.stringify(cart));
                window.dispatchEvent(new CustomEvent('cart:updated'));
            }
            function getProds() {
                try { return JSON.parse(localStorage.getItem(PROD_KEY)) || []; } catch { return []; }
            }
            function findProdInfo(id) {
                const p = getProds().find(x => String(x.id) === String(id));
                if (p) return { name: p.nombre, price: Number(p.precio)||0 };
                return null;
            }

            function renderCarrito() {
                const cart = getCart();
                const $tbody = $('#tablaCarrito tbody').empty();
                let total = 0;
                if (!cart.length) {
                    $('#cartEmpty').removeClass('d-none');
                    $('#btnConfirmar').prop('disabled', true);
                } else {
                    $('#cartEmpty').addClass('d-none');
                    $('#btnConfirmar').prop('disabled', false);
                }
                cart.forEach((it, i) => {
                    let prodInfo = findProdInfo(it.id) || {};
                    let name = it.name || prodInfo.name || `Producto ${it.id}`;
                    let price = (typeof it.price === 'number') ? it.price : (prodInfo.price || 0);
                    // Lógica para imagen según nombre
                    let img = it.img || prodInfo.img;
                    if (!img) {
                        if (name.toLowerCase().includes('monstera')) img = 'images/monstera.jpg';
                        else if (name.toLowerCase().includes('ficus')) img = 'images/ficus.jpg';
                        else if (name.toLowerCase().includes('alocasia')) img = 'images/alocasia.jpg';
                        else img = 'images/1.jpg';
                    }
                    let qty = Number(it.qty) || 1;
                    const subtotal = price * qty;
                    total += subtotal;
                    $tbody.append(`
                        <tr data-id="${it.id}">
                            <td>${i+1}</td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <img src="${img}" alt="${name}" class="img-sm" style="width:60px;height:60px;object-fit:cover;border-radius:6px;">
                                    <span>${name}</span>
                                </div>
                            </td>
                            <td class="text-end">${fmt.format(price)}</td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-secondary btnQty" data-delta="-1">-</button>
                                    <span class="btn btn-light disabled px-3">${qty}</span>
                                    <button class="btn btn-outline-secondary btnQty" data-delta="1">+</button>
                                </div>
                            </td>
                            <td class="text-end">${fmt.format(subtotal)}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-danger btnRemove">Eliminar</button>
                            </td>
                        </tr>
                    `);
                });
                $('#cartTotal').text(fmt.format(total));
            }

            $(function () {
                // proteger página (ambos roles pueden comprar)
                const user = AuthStore.getCurrentUser();
                if (!user) { location.href = 'login.html'; return; }
                if (window.Layout && window.Layout.LoadPartials) window.Layout.LoadPartials();
                renderCarrito();
                // Vaciar
                $('#btnVaciar').on('click', () => {
                    saveCart([]);
                    renderCarrito();
                });
                // Cambiar cantidades
                $(document).on('click', '.btnQty', function () {
                    const delta = Number($(this).data('delta'));
                    const id = $(this).closest('tr').data('id');
                    const cart = getCart();
                    const item = cart.find(x => String(x.id) === String(id));
                    if (!item) return;
                    const newQty = (Number(item.qty) || 1) + delta;
                    if (newQty <= 0) {
                        const next = cart.filter(x => String(x.id) !== String(id));
                        saveCart(next);
                    } else {
                        item.qty = newQty;
                        saveCart(cart);
                    }
                    renderCarrito();
                });
                // Eliminar item
                $(document).on('click', '.btnRemove', function () {
                    const id = $(this).closest('tr').data('id');
                    const next = getCart().filter(x => String(x.id) !== String(id));
                    saveCart(next);
                    renderCarrito();
                });
                // Confirmar compra
                $('#btnConfirmar').on('click', () => {
                    const totalText = $('#cartTotal').text();
                    sessionStorage.setItem('LAST_ORDER_TOTAL', totalText);
                    saveCart([]);
                    location.href = 'gracias.html';
                });
            });
        </script>
</body>
</html>
